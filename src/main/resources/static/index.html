<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenable MCP</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">Tenable MCP</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- API Configuration Section -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Access Key</label>
                        <input type="password" id="accessKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Secret Key</label>
                        <input type="password" id="secretKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Base URL</label>
                        <input type="text" id="baseUrl" value="https://cloud.tenable.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="saveConfig()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Configuration
                        </button>
                        <button onclick="testConnection()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Test Connection
                        </button>
                    </div>
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="hidden mt-4 p-4 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i id="statusIcon" class="fas"></i>
                            </div>
                            <div class="ml-3">
                                <h3 id="statusTitle" class="text-sm font-medium"></h3>
                                <div id="statusDetails" class="mt-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Ask Tenable</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Your Question</label>
                        <textarea id="query" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ask a question or continue the conversation..."></textarea>
                    </div>
                    <div>
                        <button onclick="askQuestion()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Ask
                        </button>
                    </div>
                </div>

                <!-- Response Section -->
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-900">Response</h3>
                    <div id="response" class="mt-2 space-y-4">
                        <!-- Summary Section -->
                        <div id="summary" class="p-4 bg-gray-50 rounded-md">
                            <p class="text-gray-500">Your response will appear here...</p>
                        </div>
                        
                        <!-- Data Table Section -->
                        <div id="dataTable" class="hidden overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="tableBody"></tbody>
                            </table>
                        </div>

                        <!-- Visualization Section -->
                        <div id="visualization" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <canvas id="trendChart"></canvas>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <canvas id="severityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize chart variables and conversation state
        let severityChart = null;
        let trendChart = null;
        let conversationHistory = [];
        let currentContext = {
            lastAction: null,
            lastData: null,
            filters: {}
        };

        // Load current configuration when page loads
        window.onload = function() {
            loadConfig();
            initializeConversation();
        };

        // Initialize conversation UI
        function initializeConversation() {
            const conversationDiv = document.createElement('div');
            conversationDiv.id = 'conversation';
            conversationDiv.className = 'mt-6 space-y-4';
            
            // Add conversation container before the query section
            const querySection = document.querySelector('.bg-white.shadow.rounded-lg.p-6');
            querySection.parentNode.insertBefore(conversationDiv, querySection);

            // Update the query section to be more conversational
            const queryInput = document.getElementById('query');
            queryInput.placeholder = "Ask a question or continue the conversation...";
            queryInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    askQuestion();
                }
            });
        }

        // Add a message to the conversation
        function addMessage(content, type = 'user') {
            const conversationDiv = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-3xl rounded-lg px-4 py-2 ${
                type === 'user' 
                    ? 'bg-indigo-600 text-white' 
                    : 'bg-gray-100 text-gray-900'
            }`;
            
            if (type === 'assistant') {
                messageBubble.innerHTML = `<div class="prose">${content}</div>`;
            } else {
                messageBubble.textContent = content;
            }
            
            messageDiv.appendChild(messageBubble);
            conversationDiv.appendChild(messageDiv);
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
        }

        // Load current configuration
        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.config;
                        if (config.hasAccessKey) document.getElementById('accessKey').value = '********';
                        if (config.hasSecretKey) document.getElementById('secretKey').value = '********';
                        document.getElementById('baseUrl').value = config.baseUrl || 'https://cloud.tenable.com';
                    }
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        // Save API configuration
        function saveConfig() {
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const baseUrl = document.getElementById('baseUrl').value;

            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    accessKey: accessKey,
                    secretKey: secretKey,
                    baseUrl: baseUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    loadConfig(); // Reload to show asterisks for saved keys
                } else {
                    alert('Error saving configuration: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration. Please try again.');
            });
        }

        // Test connection to Tenable.io
        function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusDetails = document.getElementById('statusDetails');

            // Show loading state
            statusDiv.className = 'mt-4 p-4 rounded-md bg-blue-50';
            statusIcon.className = 'fas fa-spinner fa-spin text-blue-400';
            statusTitle.textContent = 'Testing Connection...';
            statusDetails.textContent = 'Please wait while we verify your credentials...';
            statusDiv.classList.remove('hidden');

            fetch('/api/config/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'mt-4 p-4 rounded-md bg-green-50';
                    statusIcon.className = 'fas fa-check-circle text-green-400';
                    statusTitle.textContent = 'Connection Successful';
                    statusDetails.textContent = data.details;
                } else {
                    statusDiv.className = 'mt-4 p-4 rounded-md bg-red-50';
                    statusIcon.className = 'fas fa-exclamation-circle text-red-400';
                    statusTitle.textContent = 'Connection Failed';
                    statusDetails.textContent = data.details;
                }
            })
            .catch(error => {
                statusDiv.className = 'mt-4 p-4 rounded-md bg-red-50';
                statusIcon.className = 'fas fa-exclamation-circle text-red-400';
                statusTitle.textContent = 'Connection Error';
                statusDetails.textContent = 'Failed to test connection. Please try again.';
                console.error('Error:', error);
            });
        }

        // Function to create data visualizations
        function createVisualizations(data) {
            if (!data) return;

            // Destroy existing charts if they exist
            if (severityChart instanceof Chart) {
                severityChart.destroy();
            }
            if (trendChart instanceof Chart) {
                trendChart.destroy();
            }

            // Extract data array from either vulnerabilities or assets
            const dataArray = Array.isArray(data.vulnerabilities) ? data.vulnerabilities : 
                             Array.isArray(data.assets) ? data.assets : [];
            
            if (dataArray.length === 0) return;

            // Create severity distribution chart
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            const severityData = {
                labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
                datasets: [{
                    data: [
                        dataArray.filter(item => item.severity === 'Critical').length,
                        dataArray.filter(item => item.severity === 'High').length,
                        dataArray.filter(item => item.severity === 'Medium').length,
                        dataArray.filter(item => item.severity === 'Low').length,
                        dataArray.filter(item => !item.severity || item.severity === 'Unknown').length
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#fd7e14', '#20c997', '#6c757d']
                }]
            };

            severityChart = new Chart(severityCtx, {
                type: 'pie',
                data: severityData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Severity Distribution'
                        }
                    }
                }
            });

            // Create trend chart if timestamp data is available
            if (dataArray[0].timestamp) {
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                const dates = dataArray.map(item => new Date(item.timestamp).toLocaleDateString());
                const counts = dates.reduce((acc, date) => {
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{
                            label: 'Count',
                            data: Object.values(counts),
                            borderColor: '#007bff',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Trend Over Time'
                            }
                        }
                    }
                });
            }
        }

        // Function to ask a question
        async function askQuestion() {
            const prompt = document.getElementById('query').value;
            if (!prompt) return;

            // Add user message to conversation
            addMessage(prompt, 'user');
            
            // Clear input
            document.getElementById('query').value = '';

            const summaryDiv = document.getElementById('summary');
            const dataTableDiv = document.getElementById('dataTable');
            const visualizationDiv = document.getElementById('visualization');

            try {
                // Add context to the request
                const request = {
                    prompt,
                    context: {
                        history: conversationHistory,
                        currentContext
                    }
                };

                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });

                const data = await response.json();
                
                // Update conversation history
                conversationHistory.push({
                    role: 'user',
                    content: prompt
                });
                conversationHistory.push({
                    role: 'assistant',
                    content: data.summary
                });

                // Update context
                if (data.rawResponse && !data.rawResponse.error) {
                    currentContext.lastAction = data.rawResponse.action;
                    currentContext.lastData = data.rawResponse;
                    if (data.rawResponse.filters) {
                        currentContext.filters = { ...currentContext.filters, ...data.rawResponse.filters };
                    }
                }

                // Display the response
                addMessage(data.summary, 'assistant');

                // Clear previous visualizations
                document.getElementById('dataTable').innerHTML = '';
                if (severityChart instanceof Chart) {
                    severityChart.destroy();
                    severityChart = null;
                }
                if (trendChart instanceof Chart) {
                    trendChart.destroy();
                    trendChart = null;
                }

                // Handle raw response data
                if (data.rawResponse && !data.rawResponse.error) {
                    const rawData = data.rawResponse;
                    
                    // Check if we have vulnerabilities or assets data
                    if (rawData.vulnerabilities || rawData.assets) {
                        const tableData = rawData.vulnerabilities || rawData.assets;
                        if (Array.isArray(tableData) && tableData.length > 0) {
                            createDataTable(tableData);
                            dataTableDiv.classList.remove('hidden');

                            // Add export button if CSV is requested
                            if (prompt.toLowerCase().includes('csv')) {
                                const exportButton = document.createElement('button');
                                exportButton.className = 'mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500';
                                exportButton.innerHTML = '<i class="fas fa-download mr-2"></i>Download CSV';
                                exportButton.onclick = () => exportToCSV(tableData);
                                dataTableDiv.appendChild(exportButton);
                            }
                        }
                    }

                    // Create visualizations if we have data
                    if (rawData.vulnerabilities || rawData.assets) {
                        createVisualizations(rawData);
                        visualizationDiv.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage(`Error: ${error.message || 'Could not process the request. Please try again.'}`, 'assistant');
            }
        }

        // Function to export data to CSV
        function exportToCSV(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return;

            // Get headers from the first item
            const headers = Object.keys(data[0]);
            
            // Create CSV content
            const csvContent = [
                headers.join(','), // Header row
                ...data.map(item => 
                    headers.map(header => {
                        const value = item[header];
                        // Handle values that might contain commas
                        return typeof value === 'string' && value.includes(',') 
                            ? `"${value}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'tenable_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to create a data table
        function createDataTable(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return;

            // Clear existing table
            const tableContainer = document.getElementById('dataTable');
            tableContainer.innerHTML = '';

            // Create table
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';

            // Create header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = key.charAt(0).toUpperCase() + key.slice(1);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            data.forEach(item => {
                const row = document.createElement('tr');
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    td.textContent = value;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            tableContainer.appendChild(table);
        }

        // Function to clear conversation
        function clearConversation() {
            conversationHistory = [];
            currentContext = {
                lastAction: null,
                lastData: null,
                filters: {}
            };
            document.getElementById('conversation').innerHTML = '';
            document.getElementById('dataTable').innerHTML = '';
            document.getElementById('summary').innerHTML = '';
            if (severityChart instanceof Chart) {
                severityChart.destroy();
                severityChart = null;
            }
            if (trendChart instanceof Chart) {
                trendChart.destroy();
                trendChart = null;
            }
        }

        // Add clear conversation button
        const clearButton = document.createElement('button');
        clearButton.className = 'ml-4 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
        clearButton.innerHTML = '<i class="fas fa-trash mr-2"></i>Clear Conversation';
        clearButton.onclick = clearConversation;
        document.querySelector('.space-y-4').appendChild(clearButton);
    </script>
</body>
</html> 