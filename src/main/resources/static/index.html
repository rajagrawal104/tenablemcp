<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenable MCP</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">Tenable MCP</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- API Configuration Section -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Access Key</label>
                        <input type="password" id="accessKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Secret Key</label>
                        <input type="password" id="secretKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Base URL</label>
                        <input type="text" id="baseUrl" value="https://cloud.tenable.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="saveConfig()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Configuration
                        </button>
                        <button onclick="testConnection()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Test Connection
                        </button>
                    </div>
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="hidden mt-4 p-4 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i id="statusIcon" class="fas"></i>
                            </div>
                            <div class="ml-3">
                                <h3 id="statusTitle" class="text-sm font-medium"></h3>
                                <div id="statusDetails" class="mt-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Section -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Conversation</h2>
                    <button id="clearConversation" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-trash mr-2"></i>Clear
                    </button>
                </div>
                <div id="conversationContainer" class="space-y-4 max-h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg"></div>
            </div>

            <!-- Query Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Ask Tenable</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Your Question</label>
                        <textarea id="queryInput" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Ask a question or continue the conversation..."></textarea>
                    </div>
                    <div>
                        <button onclick="askQuestion()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Ask
                        </button>
                    </div>
                </div>

                <!-- Response Section -->
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-900">Response</h3>
                    <div id="responseContainer" class="mt-2 space-y-4">
                        <!-- Data Table Section -->
                        <div id="dataTable" class="overflow-x-auto"></div>

                        <!-- Visualization Section -->
                        <div id="visualization" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <canvas id="severityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let conversationHistory = [];
        let currentContext = {
            lastAction: null,
            filters: {}
        };

        // Initialize Chart.js
        let severityChart = null;
        let trendChart = null;

        // Load current configuration when page loads
        window.onload = function() {
            loadConfig();
        };

        // Load current configuration
        function loadConfig() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.config;
                        if (config.hasAccessKey) document.getElementById('accessKey').value = '********';
                        if (config.hasSecretKey) document.getElementById('secretKey').value = '********';
                        document.getElementById('baseUrl').value = config.baseUrl || 'https://cloud.tenable.com';
                    }
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        // Save API configuration
        function saveConfig() {
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const baseUrl = document.getElementById('baseUrl').value;

            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    accessKey: accessKey,
                    secretKey: secretKey,
                    baseUrl: baseUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    loadConfig(); // Reload to show asterisks for saved keys
                } else {
                    alert('Error saving configuration: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration. Please try again.');
            });
        }

        // Test connection to Tenable.io
        function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusDetails = document.getElementById('statusDetails');

            // Show loading state
            statusDiv.className = 'mt-4 p-4 rounded-md bg-blue-50';
            statusIcon.className = 'fas fa-spinner fa-spin text-blue-400';
            statusTitle.textContent = 'Testing Connection...';
            statusDetails.textContent = 'Please wait while we verify your credentials...';
            statusDiv.classList.remove('hidden');

            fetch('/config/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'mt-4 p-4 rounded-md bg-green-50';
                    statusIcon.className = 'fas fa-check-circle text-green-400';
                    statusTitle.textContent = 'Connection Successful';
                    statusDetails.textContent = data.details;
                } else {
                    statusDiv.className = 'mt-4 p-4 rounded-md bg-red-50';
                    statusIcon.className = 'fas fa-exclamation-circle text-red-400';
                    statusTitle.textContent = 'Connection Failed';
                    statusDetails.textContent = data.details;
                }
            })
            .catch(error => {
                statusDiv.className = 'mt-4 p-4 rounded-md bg-red-50';
                statusIcon.className = 'fas fa-exclamation-circle text-red-400';
                statusTitle.textContent = 'Connection Error';
                statusDetails.textContent = 'Failed to test connection. Please try again.';
                console.error('Error:', error);
            });
        }

        // Add a message to the conversation
        function addMessageToConversation(role, content) {
            const conversationContainer = document.getElementById('conversationContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-3xl rounded-lg px-4 py-2 ${
                role === 'user' 
                    ? 'bg-indigo-600 text-white' 
                    : 'bg-gray-100 text-gray-900'
            }`;
            
            if (role === 'assistant') {
                messageBubble.innerHTML = `<div class="prose">${content}</div>`;
            } else {
                messageBubble.textContent = content;
            }
            
            messageDiv.appendChild(messageBubble);
            conversationContainer.appendChild(messageDiv);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;

            // Add to history
            conversationHistory.push({ role, content });
        }

        // Function to ask a question
        async function askQuestion() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();
            if (!query) return;

            // Add user message to conversation
            addMessageToConversation('user', query);
            queryInput.value = '';

            // Show loading state
            const responseContainer = document.getElementById('responseContainer');
            if (responseContainer) {
                responseContainer.innerHTML = '<div class="text-gray-500">Processing your request...</div>';
            }

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: query,
                        context: {
                            messages: conversationHistory,
                            currentContext: currentContext
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Update context
                currentContext = {
                    lastAction: data.action,
                    filters: data.filters || {}
                };

                // Add assistant message to conversation
                addMessageToConversation('assistant', data.summary);

                // Clear previous visualizations
                clearVisualizations();

                // Handle the response based on the action
                if (data.rawResponse) {
                    if (data.action === 'list_vulnerabilities' || data.action === 'list_assets') {
                        createDataTable(data.rawResponse);
                        createVisualizations(data.rawResponse);
                    }
                }

                // Show download button if CSV was requested
                if (query.toLowerCase().includes('csv') && responseContainer) {
                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                    downloadButton.textContent = 'Download CSV';
                    downloadButton.onclick = () => exportToCSV(data.rawResponse);
                    responseContainer.appendChild(downloadButton);
                }

            } catch (error) {
                console.error('Error:', error);
                addMessageToConversation('assistant', `Error: ${error.message}`);
            }
        }

        function clearVisualizations() {
            // Destroy existing charts
            if (severityChart instanceof Chart) {
                severityChart.destroy();
            }
            if (trendChart instanceof Chart) {
                trendChart.destroy();
            }

            // Clear containers
            const severityChartElement = document.getElementById('severityChart');
            const trendChartElement = document.getElementById('trendChart');
            const dataTableElement = document.getElementById('dataTable');

            if (severityChartElement) severityChartElement.innerHTML = '';
            if (trendChartElement) trendChartElement.innerHTML = '';
            if (dataTableElement) dataTableElement.innerHTML = '';
        }

        function createVisualizations(data) {
            if (!data || !Array.isArray(data)) return;

            const severityChartElement = document.getElementById('severityChart');
            const trendChartElement = document.getElementById('trendChart');

            if (!severityChartElement || !trendChartElement) {
                console.error('Chart elements not found');
                return;
            }

            // Extract data for charts
            const severityData = {};
            const trendData = {};

            data.forEach(item => {
                // Severity distribution
                const severity = item.severity || 'Unknown';
                severityData[severity] = (severityData[severity] || 0) + 1;

                // Trend over time
                const date = new Date(item.created_at || item.discovered_at).toLocaleDateString();
                trendData[date] = (trendData[date] || 0) + 1;
            });

            // Create severity chart
            const severityCtx = severityChartElement.getContext('2d');
            severityChart = new Chart(severityCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(severityData),
                    datasets: [{
                        data: Object.values(severityData),
                        backgroundColor: [
                            '#dc2626', // Critical - Red
                            '#f97316', // High - Orange
                            '#eab308', // Medium - Yellow
                            '#22c55e'  // Low - Green
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Severity Distribution'
                        }
                    }
                }
            });

            // Create trend chart
            const trendCtx = trendChartElement.getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(trendData),
                    datasets: [{
                        label: 'Findings Over Time',
                        data: Object.values(trendData),
                        borderColor: '#3b82f6',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trend Over Time'
                        }
                    }
                }
            });
        }

        function createDataTable(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return;

            const tableContainer = document.getElementById('dataTable');
            if (!tableContainer) {
                console.error('Data table container not found');
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white';
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    td.textContent = value?.toString() || '';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function exportToCSV(data) {
            if (!data || !Array.isArray(data) || data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header]?.toString() || '';
                        return `"${value.replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'export.csv';
            link.click();
        }

        // Handle Enter key in input
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askQuestion();
            }
        });

        // Clear conversation
        document.getElementById('clearConversation').addEventListener('click', function() {
            conversationHistory = [];
            currentContext = {
                lastAction: null,
                filters: {}
            };
            document.getElementById('conversationContainer').innerHTML = '';
            clearVisualizations();
        });
    </script>
</body>
</html> 